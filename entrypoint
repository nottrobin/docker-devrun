#! /bin/sh

set -e

# Set local project setting defaults
# ===

# If no default port is set for this project, set it to 8000
if ! egrep -q '^PORT=[0-9]+' .env; then
  echo "Warning: No port specified. Setting port to 8000."
  export PORT=8000
  echo "PORT=${PORT}" >> .env
fi
# If no database preference, set to no database
if ! egrep -q '^DB=(false|true)' .env; then
  echo "Warning: No database preference detected. Assuming no database."
  export DB=false
  echo "DB=${DB}" >> .env
fi
# Auto-generate a unique COMPOSE_PROJECT name from the directory path
if [ ! -f ${PROJECT_NAME_FILE} ]; then
  pwd | sha1sum | awk '{print $ 1}' | cut -c 1-8 > ${PROJECT_NAME_FILE}
fi

# Initialise environment variables
# ===

# Set project name
export COMPOSE_PROJECT_NAME=$(cat ${PROJECT_NAME_FILE})

# Set the working directory
export WORKDIR=$(pwd)

# Choose compose file
export COMPOSE_FILE=/devrun/docker-compose$(${DB} && echo ".db").yml

# Run the input command
$@
