#!/bin/sh

set -e

# Auto-generate a unique COMPOSE_PROJECT name from the directory path
if [ ! -f ${PROJECT_NAME_FILE} ]; then
  pwd | sha1sum | awk '{print $1}' | cut -c 1-8 > ${PROJECT_NAME_FILE}
fi

# Set project name
export COMPOSE_PROJECT_NAME=$(cat ${PROJECT_NAME_FILE})

# Set when the dependencies were last updated
dockerfile_modified=$(date +'%s' -r Dockerfile || echo '0')
requirements_modified=$(find requirements -exec date +'%s' -r {} \; | sort -n -r | head -1 || echo '0')
export DEPENDENCIES_MODIFIED=$(( dockerfile_modified > requirements_modified ? dockerfile_modified : requirements_modified ))

# Add docker-compose file
[[ ! -e docker-compose.devrun.yml ]] && ln -s /devrun/${COMPOSE_FILE}

# If no default port is set for this project, set it to 8000
if ! egrep -q '^PORT=[0-9]+' .env; then
  echo "No port specified. Settings port to 8000."
  echo "PORT=8000" >> .env
fi

# Run the input command
$@
